name: CI

on:
  workflow_dispatch: # manual trigger only â€” activate when ready
  # push:
  #   branches: [main, "feat/**"]
  # pull_request:
  #   branches: [main]

jobs:
  flake-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - run: nix flake check --all-systems

  dev-shells:
    runs-on: ubuntu-latest
    needs: flake-check
    strategy:
      matrix:
        shell: [default, shell, rust, odin, zig, janet, cl]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Enter ${{ matrix.shell }} dev shell
        run: nix develop .#${{ matrix.shell }} --command bash -c 'echo "Shell ${{ matrix.shell }} works"'

  modules:
    runs-on: ubuntu-latest
    needs: flake-check
    strategy:
      matrix:
        module:
          - module-base-alpine
          - module-python312
          - module-nodejs22
          - module-golang
          - module-tailscale
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Build ${{ matrix.module }}
        run: nix build .#${{ matrix.module }} -L

  daemons:
    runs-on: ubuntu-latest
    needs: flake-check
    strategy:
      matrix:
        daemon:
          - squashd-rust
          - squashd-odin
          - squashd-zig
          - squashd-janet
          - squashd-shell
          # squashd-cl excluded: requires __impure (network access)
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Build ${{ matrix.daemon }}
        run: nix build .#${{ matrix.daemon }} -L

  images:
    runs-on: ubuntu-latest
    needs: [daemons, modules]
    strategy:
      matrix:
        image:
          - image-rust
          - image-odin
          - image-zig
          - image-janet
          - image-shell
          # image-cl excluded: depends on squashd-cl (impure)
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Build ${{ matrix.image }}
        run: nix build .#${{ matrix.image }} -L
      - name: Verify image loads
        run: |
          docker load < result
          docker images | grep sq-sandbox

  push-zig:
    runs-on: ubuntu-latest
    needs: images
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    env:
      ECR_REGISTRY: 620666897359.dkr.ecr.us-east-2.amazonaws.com
      ECR_IMAGE: fg-claude-bot-sandbox
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::620666897359:role/github-actions-sq-sandbox
          aws-region: us-east-2
      - uses: aws-actions/amazon-ecr-login@v2
      - name: Build and push zig image to ECR
        run: |
          nix build .#image-zig -L
          docker load < result
          SOURCE_TAG=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep sq-sandbox-zig | head -1)
          docker tag "$SOURCE_TAG" "$ECR_REGISTRY/$ECR_IMAGE:zig-latest"
          docker tag "$SOURCE_TAG" "$ECR_REGISTRY/$ECR_IMAGE:zig-${{ github.sha }}"
          docker push "$ECR_REGISTRY/$ECR_IMAGE:zig-latest"
          docker push "$ECR_REGISTRY/$ECR_IMAGE:zig-${{ github.sha }}"

  proxy:
    runs-on: ubuntu-latest
    needs: flake-check
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      - name: Build Go proxy
        run: nix build .#sq-secret-proxy -L
