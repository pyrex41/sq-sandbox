# Firecracker backend (requires /dev/kvm â€” bare metal or nested virt)
services:
  squash:
    build:
      context: .
      dockerfile: Dockerfile.firecracker
    privileged: true
    restart: unless-stopped
    ports: ["8080:8080"]
    volumes: [squash-data:/data]
    devices: [/dev/kvm:/dev/kvm]
    environment:
      SQUASH_BACKEND: firecracker
      SQUASH_AUTH_TOKEN: ${SQUASH_AUTH_TOKEN:-}
      SQUASH_S3_BUCKET: ${SQUASH_S3_BUCKET:-}
      SQUASH_S3_ENDPOINT: ${SQUASH_S3_ENDPOINT:-}
      SQUASH_S3_REGION: ${SQUASH_S3_REGION:-us-east-1}
      SQUASH_S3_PREFIX: ${SQUASH_S3_PREFIX:-}
      SQUASH_EPHEMERAL: ${SQUASH_EPHEMERAL:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      TAILSCALE_AUTHKEY: ${TAILSCALE_AUTHKEY:-}
      TAILSCALE_HOSTNAME: ${TAILSCALE_HOSTNAME:-squash}
    healthcheck:
      test: wget -qO- http://localhost:8080/cgi-bin/health
      interval: 30s
      start_period: 60s

volumes:
  squash-data:
