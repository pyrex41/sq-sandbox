#!/bin/sh
# squash/bin/sq-init — first-boot init + sandbox recovery
set -eu

DATA="${SQUASH_DATA:-/data}"
MODULES="$DATA/modules"
SANDBOXES="$DATA/sandboxes"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

log() { echo "[sq-init] $*"; }

mkdir -p "$MODULES" "$SANDBOXES"

# ── Build default base if missing ──────────────────────────────────────
if [ ! -f "$MODULES/000-base-alpine.squashfs" ]; then
    if [ -n "${SQUASH_S3_BUCKET:-}" ] && command -v sq-s3 >/dev/null 2>&1; then
        log "no base module found, trying S3"
        if sq-s3 pull "modules/000-base-alpine.squashfs" "$MODULES/000-base-alpine.squashfs" 2>/dev/null; then
            log "pulled base from S3: $(ls -lh "$MODULES/000-base-alpine.squashfs" | awk '{print $5}')"
        else
            log "S3 pull failed, building Alpine base"
            "$SCRIPT_DIR/sq-mkbase" alpine
        fi
    else
        log "no base module found, building Alpine base"
        "$SCRIPT_DIR/sq-mkbase" alpine
    fi
else
    log "base module present: $(ls -lh "$MODULES/000-base-alpine.squashfs" | awk '{print $5}')"
fi

if [ "${SQUASH_BACKEND:-chroot}" = "firecracker" ]; then
    if [ ! -f "$DATA/vm/firecracker" ]; then
        log "firecracker backend: provisioning VM components"
        "$SCRIPT_DIR/sq-mkvm" all
    else
        log "firecracker backend: VM components present"
    fi
fi

# ── Remount surviving sandboxes ────────────────────────────────────────
if [ "${SQUASH_EPHEMERAL:-}" = "1" ]; then
    log "ephemeral mode: skipping sandbox remount (S3 is source of truth)"
else
for sdir in "$SANDBOXES"/*/; do
    [ ! -f "$sdir/.meta/layers" ] && continue
    id=$(basename "$sdir")

    if grep -q "$sdir/merged" /proc/mounts 2>/dev/null; then
        log "$id: already mounted"
        continue
    fi

    log "$id: remounting"
    layers=$(cat "$sdir/.meta/layers")

    # Remount module images
    for mod in $(echo "$layers" | tr ',' ' '); do
        local_mp="$sdir/images/$mod.squashfs"
        sqfs="$MODULES/$mod.squashfs"
        if [ ! -f "$sqfs" ]; then
            if [ -n "${SQUASH_S3_BUCKET:-}" ] && command -v sq-s3 >/dev/null 2>&1; then
                log "  pulling missing module from S3: $mod"
                sq-s3 pull "modules/$mod.squashfs" "$sqfs" 2>/dev/null || {
                    log "  WARN: module missing (local and S3): $mod"; continue; }
            else
                log "  WARN: module missing: $mod"; continue
            fi
        fi
        mkdir -p "$local_mp"
        mountpoint -q "$local_mp" 2>/dev/null || \
            mount -o loop,ro -t squashfs "$sqfs" "$local_mp" 2>/dev/null || \
            { log "  WARN: mount failed: $mod"; continue; }
    done

    # Remount active snapshot if any
    if [ -f "$sdir/.meta/active_snapshot" ]; then
        label=$(cat "$sdir/.meta/active_snapshot")
        snapfile="$sdir/snapshots/$label.squashfs"
        if [ -f "$snapfile" ]; then
            mkdir -p "$sdir/images/_snapshot"
            mountpoint -q "$sdir/images/_snapshot" 2>/dev/null || \
                mount -o loop,ro -t squashfs "$snapfile" "$sdir/images/_snapshot" 2>/dev/null || true
        fi
    fi

    # Rebuild overlay
    mkdir -p "$sdir/upper" "$sdir/work" "$sdir/merged"

    # Build lowerdir
    lower=""
    if [ -d "$sdir/images/_snapshot" ] && mountpoint -q "$sdir/images/_snapshot" 2>/dev/null; then
        lower="$sdir/images/_snapshot"
    fi
    for d in $(ls -1d "$sdir"/images/[0-9]*.squashfs 2>/dev/null | sort -r); do
        mountpoint -q "$d" 2>/dev/null || continue
        [ -n "$lower" ] && lower="$lower:" || true
        lower="$lower$d"
    done

    if [ -n "$lower" ]; then
        mount -t overlay overlay \
            -o "lowerdir=$lower,upperdir=$sdir/upper,workdir=$sdir/work" \
            "$sdir/merged" 2>/dev/null && log "$id: ok" || log "$id: FAILED"
    fi
done
fi

log "ready — modules: $(ls -1 "$MODULES"/*.squashfs 2>/dev/null | wc -l), sandboxes: $(ls -1d "$SANDBOXES"/*/ 2>/dev/null | wc -l)"
