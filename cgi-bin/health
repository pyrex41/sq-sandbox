#!/bin/sh
# squash/cgi-bin/health
. "$(dirname "$0")/common.sh"

ts_status="off"
ts_ip=""
if command -v tailscale >/dev/null 2>&1; then
    ts_ip=$(tailscale ip -4 2>/dev/null || echo "")
    [ -n "$ts_ip" ] && ts_status="connected"
fi

sb_count=$(ls -1d "$SANDBOXES"/*/ 2>/dev/null | wc -l || echo 0)
mod_count=$(ls -1 "$MODULES"/*.squashfs 2>/dev/null | wc -l || echo 0)
has_base=$([ -f "$MODULES/000-base-alpine.squashfs" ] && echo true || echo false)

json_ok "$(jq -n \
    --arg backend "$BACKEND" \
    --arg ts "$ts_status" --arg ts_ip "$ts_ip" \
    --argjson sb "$sb_count" --argjson mod "$mod_count" --argjson base "$has_base" \
    '{status:"ok",backend:$backend,tailscale:{status:$ts,ip:$ts_ip},sandboxes:$sb,modules:$mod,base_ready:$base}')"
